{% extends "base.html" %}

{% block title %}Publications & Researchers - 4Front2Market{% endblock %}

{% block extra_css %}
<style>
    .search-form {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
    }
    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
    }
    .filter-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    .result-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        transition: transform 0.2s;
    }
    .result-card:hover {
        transform: translateY(-2px);
    }
    .source-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .ollama-status {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .publication-title {
        font-weight: 600;
        color: #495057;
    }
    .author-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .abstract-text {
        font-size: 0.9rem;
        color: #6c757d;
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-users"></i> 
                    Publications & Researchers
                </h1>
                
                <!-- Ollama Status -->
                <div class="ollama-status">
                    {% set ollama_status = ollama_status or {"ok": False, "msg": "Status unknown"} %}
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="mb-1">
                                <i class="fas fa-server"></i> Ollama Status
                            </h5>
                            <p class="mb-0">
                                {% if ollama_status.ok %}
                                    <i class="fas fa-check-circle"></i> Connected and ready
                                {% else %}
                                    <i class="fas fa-exclamation-triangle"></i> {{ ollama_status.msg }}
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="checkOllamaStatus()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Form -->
                <div class="search-form">
                    <form method="POST" action="{{ url_for('ollama.search_publications') }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="query" class="form-label">Search Query</label>
                                    <input type="text" class="form-control" id="query" name="query" 
                                           value="{{ request.form.get('query', '') }}" 
                                           placeholder="Enter your search query..." required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="source" class="form-label">Source</label>
                                    <select class="form-select" id="source" name="source">
                                        <option value="pubmed" {% if request.form.get('source') == 'pubmed' %}selected{% endif %}>PubMed</option>
                                        <option value="semantic_scholar" {% if request.form.get('source') == 'semantic_scholar' %}selected{% endif %}>Semantic Scholar</option>
                                        <option value="arxiv" {% if request.form.get('source') == 'arxiv' %}selected{% endif %}>arXiv</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="limit" class="form-label">Results Limit</label>
                                    <select class="form-select" id="limit" name="limit">
                                        <option value="10" {% if request.form.get('limit') == '10' %}selected{% endif %}>10</option>
                                        <option value="25" {% if request.form.get('limit') == '25' %}selected{% endif %}>25</option>
                                        <option value="50" {% if request.form.get('limit') == '50' %}selected{% endif %}>50</option>
                                        <option value="100" {% if request.form.get('limit') == '100' %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-light btn-lg">
                                    <i class="fas fa-search"></i> Search Publications
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Results Section -->
                {% if results %}
                <div class="row">
                    <div class="col-12">
                        <div class="stats-card">
                            <h5><i class="fas fa-chart-bar"></i> Search Results</h5>
                            <p class="mb-0">Found {{ results|length }} publications for "{{ request.form.get('query', '') }}"</p>
                        </div>
                        
                        <!-- Filter Section -->
                        <div class="filter-section">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="filterSource" class="form-label">Filter by Source</label>
                                    <select class="form-select" id="filterSource">
                                        <option value="">All Sources</option>
                                        <option value="pubmed">PubMed</option>
                                        <option value="semantic_scholar">Semantic Scholar</option>
                                        <option value="arxiv">arXiv</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="sortResults" class="form-label">Sort by</label>
                                    <select class="form-select" id="sortResults">
                                        <option value="relevance">Relevance</option>
                                        <option value="date">Date</option>
                                        <option value="title">Title</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Results List -->
                        <div id="resultsList">
                            {% for result in results %}
                            <div class="card result-card" data-source="{{ result.source }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title publication-title">{{ result.title }}</h5>
                                        <span class="badge bg-primary source-badge">{{ result.source }}</span>
                                    </div>
                                    
                                    {% if result.authors %}
                                    <p class="author-info mb-2">
                                        <i class="fas fa-user"></i> 
                                        {{ result.authors|join(', ') }}
                                    </p>
                                    {% endif %}
                                    
                                    {% if result.abstract %}
                                    <p class="abstract-text mb-3">{{ result.abstract[:300] }}{% if result.abstract|length > 300 %}...{% endif %}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if result.doi %}
                                            <a href="https://doi.org/{{ result.doi }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-external-link-alt"></i> DOI
                                            </a>
                                            {% endif %}
                                            {% if result.url %}
                                            <a href="{{ result.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-external-link-alt"></i> View
                                            </a>
                                            {% endif %}
                                        </div>
                                        <div>
                                                                                         <button class="btn btn-sm btn-success add-to-workshop-btn" 
                                                    data-id="{{ result.id }}" 
                                                    data-title="{{ result.title }}">
                                                <i class="fas fa-plus"></i> Add to Workshop
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function checkOllamaStatus() {
        fetch('/ollama/api/status')
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error checking Ollama status:', error);
            });
    }

    function addToWorkshop(publicationId, title) {
        fetch('/lead-workshop/add-publication', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                publication_id: publicationId,
                title: title
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Publication added to workshop successfully!');
            } else {
                alert('Error adding publication: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error adding publication: ' + error);
        });
    }

    // Filter functionality
    document.getElementById('filterSource').addEventListener('change', function() {
        const filterValue = this.value;
        const results = document.querySelectorAll('.result-card');
        
        results.forEach(result => {
            if (!filterValue || result.dataset.source === filterValue) {
                result.style.display = 'block';
            } else {
                result.style.display = 'none';
            }
        });
    });

    // Sort functionality
    document.getElementById('sortResults').addEventListener('change', function() {
        const sortBy = this.value;
        const resultsList = document.getElementById('resultsList');
        const results = Array.from(resultsList.children);
        
        results.sort((a, b) => {
            const titleA = a.querySelector('.publication-title').textContent.toLowerCase();
            const titleB = b.querySelector('.publication-title').textContent.toLowerCase();
            
            if (sortBy === 'title') {
                return titleA.localeCompare(titleB);
            } else if (sortBy === 'date') {
                // Add date sorting logic if dates are available
                return 0;
            } else {
                return 0; // relevance - keep original order
            }
        });
        
        results.forEach(result => resultsList.appendChild(result));
    });

    // Add to workshop functionality
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.add-to-workshop-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const title = this.getAttribute('data-title');
                addToWorkshop(id, title);
            });
        });
    });
</script>
{% endblock %} 