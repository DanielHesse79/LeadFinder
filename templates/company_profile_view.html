{% extends "base.html" %}

{% block title %}{{ company.company_name }} - Company Profile{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-building"></i> {{ company.company_name }} - Company Profile
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editCompanyModal">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteCompany({{ company.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <a href="{{ url_for('strategic.strategic_dashboard') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Company Overview -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h4><i class="fas fa-info-circle"></i> Company Overview</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Industry:</strong> {{ company.industry or 'Not specified' }}</p>
                                    <p><strong>Location:</strong> {{ company.location or 'Not specified' }}</p>
                                    <p><strong>Business Model:</strong> {{ company.business_model or 'Not specified' }}</p>
                                    <p><strong>Revenue Model:</strong> {{ company.revenue_model or 'Not specified' }}</p>
                                </div>
                                <div class="col-md-6">
                                    {% if company.get('website') %}
                                    <p><strong>Website:</strong> <a href="{{ company.website }}" target="_blank">{{ company.website }}</a></p>
                                    {% endif %}
                                    <p><strong>Created:</strong> {{ company.created_at[:10] }}</p>
                                    {% if company.get('last_mined') %}
                                    <p><strong>Last Data Mining:</strong> {{ company.last_mined[:10] }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5><i class="fas fa-star"></i> Quick Stats</h5>
                                    {% if company.get('mined_data') %}
                                    <p><strong>News Articles:</strong> {{ company.mined_data.news_analysis.news_count|default(0) }}</p>
                                    <p><strong>Total Funding:</strong> ${{ "{:,.0f}".format(company.mined_data.financial_intelligence.funding_history.total_funding|default(0)) }}</p>
                                    <p><strong>Innovation Score:</strong> {{ company.mined_data.ip_landscape.innovation_indicators.innovation_score|default(0)|round(1) }}/10</p>
                                    {% else %}
                                    <p class="text-muted">No data mining completed yet</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- USP Focus Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4><i class="fas fa-bullseye"></i> Unique Selling Propositions (USPs)</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if company.usps %}
                                    <div class="usp-content">
                                        {{ company.usps|safe|replace('\n', '<br>') }}
                                    </div>
                                    {% else %}
                                    <p class="text-muted">No USPs defined yet. <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#editCompanyModal">Add USPs</button></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product/Service Portfolio -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4><i class="fas fa-box"></i> Product/Service Description</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if company.product_description %}
                                    <p>{{ company.product_description|safe|replace('\n', '<br>') }}</p>
                                    {% else %}
                                    <p class="text-muted">No product description available</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4><i class="fas fa-list"></i> Service Portfolio</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if company.service_portfolio %}
                                    <p>{{ company.service_portfolio|safe|replace('\n', '<br>') }}</p>
                                    {% else %}
                                    <p class="text-muted">No service portfolio available</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Target Market -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4><i class="fas fa-users"></i> Target Market</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if company.target_market %}
                                    <p>{{ company.target_market|safe|replace('\n', '<br>') }}</p>
                                    {% else %}
                                    <p class="text-muted">No target market defined</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mined Data Intelligence -->
                    {% if company.get('mined_data') %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4><i class="fas fa-database"></i> Data Intelligence</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-newspaper"></i> News Analysis</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Sentiment:</strong> {{ company.mined_data.news_analysis.sentiment_analysis|default('Neutral') }}</p>
                                            <p><strong>Key Topics:</strong> {{ company.mined_data.news_analysis.key_topics|join(', ') if company.mined_data.news_analysis.key_topics else 'None' }}</p>
                                            <p><strong>News Count:</strong> {{ company.mined_data.news_analysis.news_count|default(0) }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-dollar-sign"></i> Financial Intelligence</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Total Funding:</strong> ${{ "{:,.0f}".format(company.mined_data.financial_intelligence.funding_history.total_funding|default(0)) }}</p>
                                            <p><strong>Funding Rounds:</strong> {{ company.mined_data.financial_intelligence.funding_history.funding_rounds|length|default(0) }}</p>
                                            <p><strong>Estimated Valuation:</strong> ${{ "{:,.0f}".format(company.mined_data.financial_intelligence.valuation_estimates.estimated_valuation|default(0)) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-lightbulb"></i> Innovation & IP</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Patent Count:</strong> {{ company.mined_data.ip_landscape.patent_count|default(0) }}</p>
                                            <p><strong>Innovation Score:</strong> {{ company.mined_data.ip_landscape.innovation_indicators.innovation_score|default(0)|round(1) }}/10</p>
                                            <p><strong>Technology Maturity:</strong> {{ company.mined_data.ip_landscape.innovation_indicators.technology_maturity|default('Unknown') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-users"></i> Talent & Expertise</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Expertise Areas:</strong> {{ company.mined_data.talent_mapping.expertise_areas|join(', ') if company.mined_data.talent_mapping.expertise_areas else 'None' }}</p>
                                            <p><strong>Professional Network:</strong> {{ company.mined_data.talent_mapping.talent_indicators.professional_network_size|default(0) }} connections</p>
                                            <p><strong>Expertise Diversity:</strong> {{ company.mined_data.talent_mapping.talent_indicators.expertise_diversity|default(0) }} areas</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Strategic Analysis Results -->
                    {% if market_research or swot_analysis or strategic_plans %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4><i class="fas fa-chart-line"></i> Strategic Analysis</h4>
                            <div class="row">
                                {% if market_research %}
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-chart-bar"></i> Market Research</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Status:</strong> <span class="badge badge-success">Completed</span></p>
                                            <p><strong>Last Updated:</strong> {{ market_research.created_at[:10] if market_research.created_at else 'Unknown' }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if swot_analysis %}
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-chart-pie"></i> SWOT Analysis</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Status:</strong> <span class="badge badge-success">Completed</span></p>
                                            <p><strong>Last Updated:</strong> {{ swot_analysis.created_at[:10] if swot_analysis.created_at else 'Unknown' }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if strategic_plans %}
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-file-alt"></i> Strategic Plans</h5>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Plans Generated:</strong> {{ strategic_plans|length }}</p>
                                            <p><strong>Last Updated:</strong> {{ strategic_plans[0].created_at[:10] if strategic_plans else 'Unknown' }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <h4><i class="fas fa-cogs"></i> Actions</h4>
                            <div class="btn-group" role="group">
                                <button class="btn btn-success" onclick="mineData({{ company.id }})">
                                    <i class="fas fa-search"></i> Mine Data
                                </button>
                                <button class="btn btn-info" onclick="conductMarketResearch({{ company.id }})">
                                    <i class="fas fa-chart-bar"></i> Market Research
                                </button>
                                <button class="btn btn-warning" onclick="conductSwotAnalysis({{ company.id }})">
                                    <i class="fas fa-chart-pie"></i> SWOT Analysis
                                </button>
                                <button class="btn btn-primary" onclick="generateStrategicPlans({{ company.id }})">
                                    <i class="fas fa-file-alt"></i> Generate Plans
                                </button>
                                <button class="btn btn-dark" onclick="comprehensiveAnalysis({{ company.id }})">
                                    <i class="fas fa-rocket"></i> Comprehensive Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Company Profile</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCompanyForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editCompanyName">Company Name *</label>
                                <input type="text" class="form-control" id="editCompanyName" value="{{ company.company_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editIndustry">Industry</label>
                                <input type="text" class="form-control" id="editIndustry" value="{{ company.industry or '' }}" 
                                       placeholder="e.g., Technology, Healthcare, Finance">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editProductDescription">Product/Service Description *</label>
                        <textarea class="form-control" id="editProductDescription" rows="3" required
                                  placeholder="Describe your main product or service">{{ company.product_description or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editTargetMarket">Target Market</label>
                        <textarea class="form-control" id="editTargetMarket" rows="2"
                                  placeholder="Describe your target customers">{{ company.target_market or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUsps">Unique Selling Propositions (USPs) *</label>
                        <textarea class="form-control" id="editUsps" rows="4" required
                                  placeholder="What makes your product/service unique? List key differentiators, competitive advantages, and value propositions">{{ company.usps or '' }}</textarea>
                        <small class="form-text text-muted">Focus on what makes your company/products truly unique and valuable to customers.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="editServicePortfolio">Service Portfolio</label>
                        <textarea class="form-control" id="editServicePortfolio" rows="3"
                                  placeholder="List your main services or products">{{ company.service_portfolio or '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editBusinessModel">Business Model</label>
                                <input type="text" class="form-control" id="editBusinessModel" value="{{ company.business_model or '' }}"
                                       placeholder="e.g., SaaS, Marketplace, Consulting">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editRevenueModel">Revenue Model</label>
                                <input type="text" class="form-control" id="editRevenueModel" value="{{ company.revenue_model or '' }}"
                                       placeholder="e.g., Subscription, Commission, Fixed Fee">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteCompany(companyId) {
    if (confirm('Are you sure you want to delete this company profile? This action cannot be undone.')) {
        $.ajax({
            url: '/strategic/company/' + companyId + '/delete',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('Company profile deleted successfully');
                    window.location.href = '{{ url_for("strategic.strategic_dashboard") }}';
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('Error: ' + (response ? response.error : 'Unknown error'));
            }
        });
    }
}

function mineData(companyId) {
    if (confirm('Mine comprehensive company data from multiple sources? This may take a few minutes.')) {
        $.ajax({
            url: '/strategic/company/' + companyId + '/mine-data',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('Data mining completed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('Error: ' + (response ? response.error : 'Unknown error'));
            }
        });
    }
}

function conductMarketResearch(companyId) {
    if (confirm('Conduct market research for this company? This may take a few minutes.')) {
        $.ajax({
            url: '/strategic/company/' + companyId + '/market-research',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('Market research completed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('Error: ' + (response ? response.error : 'Unknown error'));
            }
        });
    }
}

function conductSwotAnalysis(companyId) {
    if (confirm('Conduct SWOT analysis for this company? This may take a few minutes.')) {
        $.ajax({
            url: '/strategic/company/' + companyId + '/swot-analysis',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('SWOT analysis completed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('Error: ' + (response ? response.error : 'Unknown error'));
            }
        });
    }
}

function generateStrategicPlans(companyId) {
    if (confirm('Generate strategic plans for this company? This may take several minutes.')) {
        // Generate all three plan types
        const plans = ['market_plan', 'business_plan', 'gtm_strategy'];
        let completed = 0;
        
        plans.forEach(function(planType) {
            $.ajax({
                url: '/strategic/company/' + companyId + '/generate-plan/' + planType,
                method: 'POST',
                success: function(response) {
                    completed++;
                    if (response.success) {
                        console.log(planType + ' generated successfully');
                    } else {
                        console.error('Error generating ' + planType + ': ' + response.error);
                    }
                    
                    if (completed === plans.length) {
                        alert('Strategic plans generated successfully!');
                        location.reload();
                    }
                },
                error: function(xhr) {
                    completed++;
                    const response = xhr.responseJSON;
                    console.error('Error generating ' + planType + ': ' + (response ? response.error : 'Unknown error'));
                    
                    if (completed === plans.length) {
                        alert('Plan generation completed with some errors. Check console for details.');
                        location.reload();
                    }
                }
            });
        });
    }
}

function comprehensiveAnalysis(companyId) {
    if (confirm('Conduct comprehensive analysis including data mining, market research, and SWOT analysis? This may take several minutes.')) {
        $.ajax({
            url: '/strategic/company/' + companyId + '/comprehensive-analysis',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert('Comprehensive analysis completed successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert('Error: ' + (response ? response.error : 'Unknown error'));
            }
        });
    }
}

// Edit company profile
$('#saveEditBtn').click(function() {
    const companyData = {
        company_name: $('#editCompanyName').val(),
        product_description: $('#editProductDescription').val(),
        target_market: $('#editTargetMarket').val(),
        usps: $('#editUsps').val(),
        service_portfolio: $('#editServicePortfolio').val(),
        industry: $('#editIndustry').val(),
        business_model: $('#editBusinessModel').val(),
        revenue_model: $('#editRevenueModel').val()
    };
    
    if (!companyData.company_name || !companyData.product_description || !companyData.usps) {
        alert('Company name, product description, and USPs are required');
        return;
    }
    
    $.ajax({
        url: '/strategic/company/{{ company.id }}/update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(companyData),
        success: function(response) {
            if (response.success) {
                $('#editCompanyModal').modal('hide');
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            alert('Error: ' + (response ? response.error : 'Unknown error'));
        }
    });
});
</script>
{% endblock %}