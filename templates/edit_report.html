{% extends "base.html" %}

{% block title %}Edit Report - {{ project.name }} - 4Front2Market{% endblock %}

{% block extra_css %}
<style>
    .edit-container {
        background: linear-gradient(135deg, var(--4front-dark-blue) 0%, var(--4front-mid-blue) 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .preview-section {
        background: var(--4front-light-gray);
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .company-branding {
        background: linear-gradient(135deg, var(--4front-teal) 0%, var(--4front-light-teal) 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .form-control:focus {
        border-color: var(--4front-teal);
        box-shadow: 0 0 0 0.2rem rgba(0, 138, 143, 0.25);
    }
    .btn-save {
        background: linear-gradient(135deg, var(--4front-dark-blue) 0%, var(--4front-mid-blue) 100%);
        border: none;
        color: white;
    }
    .btn-save:hover {
        background: linear-gradient(135deg, var(--4front-mid-blue) 0%, var(--4front-dark-blue) 100%);
        color: white;
    }
    .btn-preview {
        background: var(--4front-yellow);
        border: none;
        color: var(--4front-dark-blue);
    }
    .btn-preview:hover {
        background: #e6a500;
        color: var(--4front-dark-blue);
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-edit"></i> Edit Report</h1>
                <p class="mb-0">Customize your report content and branding before PDF generation</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('lead_workshop.view_project', project_id=project.id) }}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Back to Project
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Company Branding Section -->
    <div class="company-branding">
        <h4><i class="fas fa-building"></i> Company Branding</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="companyName" class="form-label">Company Name</label>
                    <input type="text" class="form-control" id="companyName" value="4Front 2 Market AB">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="disclaimer" class="form-label">Disclaimer</label>
                    <input type="text" class="form-control" id="disclaimer" value="This is a beta-version. Data might be unreliable.">
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content Editing -->
    <div class="form-section">
        <h4><i class="fas fa-file-alt"></i> Report Content</h4>
        
        <div class="mb-3">
            <label for="background" class="form-label">Background and Purpose</label>
            <textarea class="form-control" id="background" rows="4" placeholder="Enter custom background text...">This report presents the results of an AI-powered lead discovery analysis conducted using 4Front 2 Market AB's advanced semantic analysis capabilities. The analysis leverages machine learning algorithms to identify and evaluate potential business opportunities, research collaborations, and market intelligence from diverse data sources including academic publications, industry reports, and web content.</textarea>
        </div>
        
        <div class="mb-3">
            <label for="methodology" class="form-label">Methodology</label>
            <textarea class="form-control" id="methodology" rows="4" placeholder="Enter custom methodology text...">The analysis was conducted using 4Front 2 Market AB's proprietary AI algorithms and data processing techniques. Each lead was evaluated based on multiple criteria including relevance to the project scope, business potential, and collaboration opportunities.</textarea>
        </div>
        
        <div class="mb-3">
            <label for="objectives" class="form-label">Key Objectives</label>
            <textarea class="form-control" id="objectives" rows="6" placeholder="Enter custom objectives...">• Identify high-potential leads and business opportunities relevant to the project scope
• Benchmark market activity and identify emerging trends in the target domain
• Extract actionable intelligence including contact information, product details, and collaboration opportunities
• Provide evidence-based recommendations for strategic decision-making
• Establish a foundation for ongoing market monitoring and lead generation</textarea>
        </div>
    </div>

    <!-- Project Information -->
    <div class="form-section">
        <h4><i class="fas fa-info-circle"></i> Project Information</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="projectName" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="projectName" value="{{ project.name }}">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="projectDate" class="form-label">Report Date</label>
                    <input type="date" class="form-control" id="projectDate" value="{{ project.created_at.strftime('%Y-%m-%d') }}">
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label for="projectDescription" class="form-label">Project Description</label>
            <textarea class="form-control" id="projectDescription" rows="3">{{ project.description or 'No description provided' }}</textarea>
        </div>
    </div>

    <!-- Lead Analysis Summary -->
    <div class="form-section">
        <h4><i class="fas fa-chart-bar"></i> Lead Analysis Summary</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="text-primary">{{ project.leads|length }}</h5>
                    <p class="text-muted">Total Leads</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="text-success">{{ project.leads|selectattr('status', 'equalto', 'qualified')|list|length }}</h5>
                    <p class="text-muted">Qualified</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="text-warning">{{ project.leads|selectattr('status', 'equalto', 'contacted')|list|length }}</h5>
                    <p class="text-muted">Contacted</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="text-info">{{ project.leads|selectattr('status', 'equalto', 'converted')|list|length }}</h5>
                    <p class="text-muted">Converted</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Actions -->
    <div class="form-section">
        <h4><i class="fas fa-cogs"></i> Report Actions</h4>
        <div class="row">
            <div class="col-md-6">
                <button type="button" class="btn btn-save btn-lg w-100 mb-2" onclick="saveReport()">
                    <i class="fas fa-save"></i> Save Report
                </button>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-preview btn-lg w-100 mb-2" onclick="previewReport()">
                    <i class="fas fa-eye"></i> Preview Report
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <a href="{{ url_for('lead_workshop.export_pdf', project_id=project.id) }}" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('lead_workshop.export_markdown', project_id=project.id) }}" class="btn btn-info btn-lg w-100">
                    <i class="fas fa-file-alt"></i> Export Markdown
                </a>
            </div>
            <div class="col-md-4">
                <!-- <a href="{{ url_for('lead_workshop.export_project_excel', project_id=project.id) }}" class="btn btn-warning btn-lg w-100">
                    <i class="fas fa-file-excel"></i> Export Excel
                </a> -->
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="previewSection" style="display: none;">
        <h4><i class="fas fa-eye"></i> Report Preview</h4>
        <div id="reportPreview">
            <!-- Preview content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function saveReport() {
        const reportData = {
            company_name: document.getElementById('companyName').value,
            disclaimer: document.getElementById('disclaimer').value,
            background: document.getElementById('background').value,
            methodology: document.getElementById('methodology').value,
            objectives: document.getElementById('objectives').value,
            project_name: document.getElementById('projectName').value,
            project_date: document.getElementById('projectDate').value,
            project_description: document.getElementById('projectDescription').value
        };
        
        fetch('{{ url_for("lead_workshop.update_analysis", project_id=project.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Report saved successfully!');
            } else {
                alert('Error saving report: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving report: ' + error);
        });
    }
    
    function previewReport() {
        const previewSection = document.getElementById('previewSection');
        const reportPreview = document.getElementById('reportPreview');
        
        // Show preview section
        previewSection.style.display = 'block';
        
        // Generate preview content
        const companyName = document.getElementById('companyName').value;
        const background = document.getElementById('background').value;
        const methodology = document.getElementById('methodology').value;
        const objectives = document.getElementById('objectives').value;
        
        reportPreview.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h5>${companyName}</h5>
                    <p class="text-muted">Lead Discovery Report</p>
                </div>
                <div class="card-body">
                    <h6>Background and Purpose</h6>
                    <p>${background}</p>
                    
                    <h6>Methodology</h6>
                    <p>${methodology}</p>
                    
                    <h6>Key Objectives</h6>
                    <p>${objectives}</p>
                </div>
            </div>
        `;
        
        // Scroll to preview
        previewSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Auto-save functionality
    let autoSaveTimer;
    function setupAutoSave() {
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    console.log('Auto-saving...');
                    // Uncomment to enable auto-save
                    // saveReport();
                }, 3000);
            });
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        setupAutoSave();
        console.log('Edit report page loaded');
    });
</script>
{% endblock %} 