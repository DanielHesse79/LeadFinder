{% extends "base.html" %}

{% block title %}Configuration - LeadFinder{% endblock %}

{% block meta_description %}Manage LeadFinder configuration settings and API keys{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .config-item {
        background: white;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    .config-item.missing {
        border-left-color: #dc3545;
        background-color: #fff5f5;
    }
    .config-item.configured {
        border-left-color: #28a745;
        background-color: #f8fff9;
    }
    .secret-field {
        position: relative;
    }
    .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
    }
    .status-badge {
        font-size: 0.75em;
    }
    .test-button {
        font-size: 0.8em;
    }
    .config-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .config-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    .config-card-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1.5rem;
        border: none;
    }
    .config-card-body {
        padding: 2rem;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
    }
    .btn-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(67, 233, 123, 0.3);
    }
    .btn-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(250, 112, 154, 0.3);
    }
    .alert {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .badge {
        border-radius: 0.5rem;
        font-weight: 500;
    }
    .badge-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    .badge-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .badge-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    .badge-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }
    .form-check-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .modal-content {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
    }
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem 1rem 0 0;
        border: none;
    }
    .modal-body {
        padding: 2rem;
    }
    .modal-footer {
        border: none;
        padding: 1.5rem 2rem;
    }
    .btn-close {
        filter: invert(1);
    }
    @media (max-width: 768px) {
        .config-card-body {
            padding: 1rem;
        }
        .config-header {
            padding: 1.5rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Configuration Header -->
    <div class="config-header">
        <div class="container">
            <h1 class="display-4 mb-3">
                <i class="fas fa-cogs me-3"></i>Configuration Management
            </h1>
            <p class="lead mb-0">Manage API keys, settings, and system configuration</p>
        </div>
    </div>

    <div class="container">
        <!-- Configuration Status -->
        <div class="alert {% if is_configured %}alert-success{% else %}alert-warning{% endif %} mb-4">
            <h5 class="alert-heading">
                <i class="fas fa-info-circle"></i> 
                Configuration Status
            </h5>
            {% if is_configured %}
                <p class="mb-0">
                    <i class="fas fa-check-circle"></i> 
                    All required configurations are set. The application is ready to use.
                </p>
            {% else %}
                <p class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Some required configurations are missing. Please configure the following:
                </p>
                <ul class="mb-0 mt-2">
                    {% for config in missing_configs %}
                    <li><strong>{{ config }}</strong></li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <!-- API Keys Management Link -->
        <div class="config-card">
            <div class="config-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>API Keys Management
                </h5>
            </div>
            <div class="config-card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>API Keys are managed separately</strong> to provide better organization and security.
                </div>
                <div class="text-center">
                    <a href="{{ url_for('api_keys.api_keys_dashboard') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-key me-2"></i>Manage API Keys
                    </a>
                    <p class="text-muted mt-2">
                        Configure API keys for SerpAPI, Semantic Scholar, PubMed, and other services
                    </p>
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div class="config-card">
            <div class="config-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>System Settings
                </h5>
            </div>
            <div class="config-card-body">
                <form method="POST" action="{{ url_for('config.update_config') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="database_url" class="form-label">
                                    <i class="fas fa-database"></i> Database URL
                                </label>
                                <input type="text" class="form-control" id="database_url" name="DATABASE_URL" 
                                       value="{{ config.get('DATABASE_URL', '') }}" placeholder="sqlite:///leadfinder.db">
                                <small class="form-text text-muted">
                                    Database connection string. Default: SQLite database
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ollama_url" class="form-label">
                                    <i class="fas fa-server"></i> Ollama URL
                                </label>
                                <input type="text" class="form-control" id="ollama_url" name="OLLAMA_URL" 
                                       value="{{ config.get('OLLAMA_URL', 'http://localhost:11434') }}" placeholder="http://localhost:11434">
                                <small class="form-text text-muted">
                                    Ollama server URL for local AI processing
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_results" class="form-label">
                                    <i class="fas fa-list-ol"></i> Maximum Results
                                </label>
                                <input type="number" class="form-control" id="max_results" name="MAX_RESULTS" 
                                       value="{{ config.get('MAX_RESULTS', 50) }}" min="1" max="1000">
                                <small class="form-text text-muted">
                                    Maximum number of results per search
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="timeout" class="form-label">
                                    <i class="fas fa-clock"></i> Request Timeout
                                </label>
                                <input type="number" class="form-control" id="timeout" name="REQUEST_TIMEOUT" 
                                       value="{{ config.get('REQUEST_TIMEOUT', 30) }}" min="5" max="300">
                                <small class="form-text text-muted">
                                    Request timeout in seconds
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="debug_mode" class="form-label">
                                    <i class="fas fa-bug"></i> Debug Mode
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="debug_mode" name="DEBUG_MODE" 
                                           value="true" {% if config.get('DEBUG_MODE', 'False').lower() == 'true' %}checked{% endif %}>
                                    <label class="form-check-label" for="debug_mode">
                                        Enable debug mode for detailed logging
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="auto_analyze" class="form-label">
                                    <i class="fas fa-robot"></i> Auto AI Analysis
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_analyze" name="AUTO_ANALYZE" 
                                           value="true" {% if config.get('AUTO_ANALYZE', 'True').lower() == 'true' %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_analyze">
                                        Automatically analyze leads with AI
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Save System Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- RunPod.ai Configuration -->
        <div class="config-card">
            <div class="config-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cloud me-2"></i>RunPod.ai Smart Configuration
                </h5>
            </div>
            <div class="config-card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Smart RunPod Integration:</strong> RunPod.ai provides enhanced AI analysis with more powerful models. Configure when to use it automatically.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="runpod_enabled" name="RUNPOD_ENABLED" value="True">
                            <label class="form-check-label" for="runpod_enabled">
                                <strong>Enable RunPod.ai Integration</strong>
                            </label>
                            <small class="form-text text-muted d-block">
                                Allow the system to use RunPod.ai for enhanced analysis
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="runpod_auto_enable" name="RUNPOD_AUTO_ENABLE" value="True" checked>
                            <label class="form-check-label" for="runpod_auto_enable">
                                <strong>Auto-Enable for Batch Processing</strong>
                            </label>
                            <small class="form-text text-muted d-block">
                                Automatically use RunPod when analyzing 5+ leads
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="runpod_complex_analysis" name="RUNPOD_COMPLEX_ANALYSIS" value="True" checked>
                            <label class="form-check-label" for="runpod_complex_analysis">
                                <strong>Use for Complex Analysis</strong>
                            </label>
                            <small class="form-text text-muted d-block">
                                Use RunPod for detailed insights and comprehensive analysis
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="runpod_fallback" name="RUNPOD_FALLBACK_TO_OLLAMA" value="True" checked>
                            <label class="form-check-label" for="runpod_fallback">
                                <strong>Fallback to Ollama</strong>
                            </label>
                            <small class="form-text text-muted d-block">
                                Use Ollama if RunPod fails or is unavailable
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="runpod_batch_threshold" class="form-label">Batch Processing Threshold</label>
                        <input type="number" class="form-control" id="runpod_batch_threshold" name="RUNPOD_BATCH_THRESHOLD" value="5" min="1" max="20">
                        <small class="form-text text-muted">
                            Number of leads that triggers automatic RunPod usage
                        </small>
                    </div>
                    <div class="col-md-6">
                        <label for="runpod_timeout" class="form-label">RunPod Timeout (seconds)</label>
                        <input type="number" class="form-control" id="runpod_timeout" name="RUNPOD_TIMEOUT" value="300" min="60" max="600">
                        <small class="form-text text-muted">
                            Maximum time to wait for RunPod analysis
                        </small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        <strong>Smart Usage:</strong> 
                        • Single leads (1-4): Ollama (fast, free)<br>
                        • Batch processing (5+ leads): RunPod (enhanced)<br>
                        • Complex analysis: RunPod (detailed insights)<br>
                        • Always fallback to Ollama if RunPod fails
                    </small>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="config-card">
            <div class="config-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>System Status
                </h5>
            </div>
            <div class="config-card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-database fa-3x text-primary mb-2"></i>
                            <h6>Database</h6>
                            <span class="badge badge-success">Connected</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-server fa-3x text-info mb-2"></i>
                            <h6>Ollama</h6>
                            <span class="badge badge-success">Online</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-search fa-3x text-warning mb-2"></i>
                            <h6>Search APIs</h6>
                            <span class="badge badge-success">Available</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-robot fa-3x text-success mb-2"></i>
                            <h6>AI Models</h6>
                            <span class="badge badge-success">Ready</span>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-warning" onclick="testAllServices()">
                        <i class="fas fa-vial me-2"></i>Test All Services
                    </button>
                    <button type="button" class="btn btn-info" onclick="viewSystemLogs()">
                        <i class="fas fa-file-alt me-2"></i>View Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1" aria-labelledby="testResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testResultsModalLabel">API Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="testResultsBody">
                <!-- Test results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration page specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Toggle password visibility
    window.togglePassword = function(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    };
    
    // Test API key
    window.testApiKey = function(fieldId, apiType) {
        const field = document.getElementById(fieldId);
        const apiKey = field.value;
        
        if (!apiKey) {
            showNotification('Please enter an API key first', 'warning');
            return;
        }
        
        showNotification('Testing API key...', 'info');
        
        fetch('/api/config/test_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                api_type: apiType,
                api_key: apiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('API key test successful!', 'success');
            } else {
                showNotification('API key test failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showNotification('Test failed: ' + error.message, 'danger');
        });
    };
    
    // Test all services
    window.testAllServices = function() {
        showNotification('Testing all services...', 'info');
        
        fetch('/api/config/test_all_services', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('testResultsBody');
            let resultsHtml = '<h6>Service Test Results</h6>';
            
            Object.entries(data.results).forEach(([service, result]) => {
                const statusClass = result.success ? 'success' : 'danger';
                const statusIcon = result.success ? 'check-circle' : 'times-circle';
                
                resultsHtml += `
                    <div class="alert alert-${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        <strong>${service}:</strong> ${result.message}
                    </div>
                `;
            });
            
            modalBody.innerHTML = resultsHtml;
            
            const modal = new bootstrap.Modal(document.getElementById('testResultsModal'));
            modal.show();
        })
        .catch(error => {
            showNotification('Service test failed: ' + error.message, 'danger');
        });
    };
    
    // View system logs
    window.viewSystemLogs = function() {
        fetch('/api/config/get_logs')
            .then(response => response.json())
            .then(data => {
                const modalBody = document.getElementById('testResultsBody');
                modalBody.innerHTML = `
                    <h6>System Logs</h6>
                    <pre style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem;">${data.logs}</pre>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('testResultsModal'));
                modal.show();
            })
            .catch(error => {
                showNotification('Failed to load logs: ' + error.message, 'danger');
            });
    };
});
</script>
{% endblock %} 